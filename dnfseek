#!/bin/bash
# ---------- SAFETY CHECKS ----------
command -v fzf >/dev/null 2>&1 || {
  echo "‚ùå fzf not installed. Please run: sudo dnf install -y fzf"
  exit 1
}
command -v dnf >/dev/null 2>&1 || {
  echo "‚ùå dnf not found. This script is for Fedora-based systems."
  exit 1
}

# ---------- CACHE SETUP ----------
CACHE_DIR="$HOME/.cache/dnfseek"
mkdir -p "$CACHE_DIR"

installed_cache="$CACHE_DIR/installed"
available_cache="$CACHE_DIR/available"

update_cache() {
  echo "‚è≥ Updating package lists..."
  # Use temp files then move to avoid partial reads
  local tmp_inst=$(mktemp)
  local tmp_avail=$(mktemp)

  dnf -q list --installed 2>/dev/null | awk 'NF>=3 && $2 ~ /[0-9.-]/ {print $1}' >"$tmp_inst"
  dnf -q -y --setopt=gpgcheck=1 --setopt=repo_gpgcheck=1 list --available 2>/dev/null | awk 'NF>=3 && $2 ~ /[0-9.-]/ {print $1}' >"$tmp_avail"

  mv "$tmp_inst" "$installed_cache"
  mv "$tmp_avail" "$available_cache"
  echo "‚úÖ Cache updated."
}

cleanup() {
  echo -e "\nüëã Exiting..."
}
trap cleanup EXIT

# Initial cache check: fetch if missing or older than 24h
if [[ ! -f "$installed_cache" || ! -f "$available_cache" ]] ||
  [[ $(find "$installed_cache" -mmin +1440 2>/dev/null) ]]; then
  update_cache
fi

# ---------- MAIN LOOP ----------
while true; do
  # ===== MAIN MENU =====
  mode=$(printf "üîé Search all packages\nüìó Show installed packages\nüÜô Upgrade all packages\nüîÑ Refresh cache\n‚ùå Quit" |
    fzf --prompt="Main Menu: " \
      --header=$'‚¨Ü‚¨á Navigate | ‚èé Select | Ctrl-C Quit' \
      --height=99% \
      --reverse)

  case "$mode" in
  "‚ùå Quit" | "") exit 0 ;;
  "üìó Show installed packages") filter_installed=true ;;
  "üîé Search all packages") filter_installed=false ;;
  "üÜô Upgrade all packages")
    sudo dnf upgrade
    update_cache
    continue
    ;;
  "üîÑ Refresh cache")
    update_cache
    continue
    ;;
  esac

  # ===== PACKAGE LIST =====
  if [ "$filter_installed" = true ]; then
    package_list=$(
      awk '{print "\033[32m" $1 " ‚úÖ\033[0m"}' "$installed_cache"
    )
  else
    # merge installed + available (color installed green)
    package_list=$(
      {
        awk '{print "\033[32m" $1 " ‚úÖ\033[0m"}' "$installed_cache"
        grep -vxFf "$installed_cache" "$available_cache"
      } | sort -u
    )
  fi

  # ===== PACKAGE SELECTION =====
  selected_pkg=$(echo "$package_list" |
    fzf --ansi \
      --prompt="üîé Search package: " \
      --header=$'‚¨Ü‚¨á Navigate | ‚èé Select | Ctrl-C Back\n\033[32mGreen = Installed ‚úÖ\033[0m | White = Available' \
      --height=99% \
      --reverse \
      --preview 'pkg=$(echo {} | sed "s/ ‚úÖ//" | sed "s/\x1b\[[0-9;]*m//g"); dnf info "$pkg" 2>/dev/null | grep -E "^(Name|Summary|Version|Release|Size|URL)"' \
      --preview-window=down:wrap:25%)

  [ -z "$selected_pkg" ] && continue

  # Clean up the package name (remove the checkmark and colors)
  clean_pkg=$(echo "$selected_pkg" | sed "s/ ‚úÖ//" | sed "s/\x1b\[[0-9;]*m//g")

  # Check if the cleaned package name is in the installed cache
  if grep -qxF "$clean_pkg" "$installed_cache"; then
    status="installed"
  else
    status="available"
  fi

  # ===== ACTION MENU =====
  if [ "$status" = "installed" ]; then
    action=$(printf "üì¶ Reinstall\nüóëÔ∏è Remove\n‚¨ÜÔ∏è Update\nüß© Dependencies\n‚Ü©Ô∏è Back" |
      fzf --prompt="Choose action: " \
        --header="Selected (installed): $clean_pkg" \
        --height=99% \
        --reverse)
  else
    action=$(printf "üì¶ Install\nüß© Dependencies\n‚Ü©Ô∏è Back" |
      fzf --prompt="Choose action: " \
        --header="Selected (available): $clean_pkg" \
        --height=99% \
        --reverse)
  fi

  case "$action" in
  "üì¶ Install")
    sudo dnf install -y "$clean_pkg" && update_cache
    ;;
  "üì¶ Reinstall")
    sudo dnf reinstall -y "$clean_pkg" && update_cache
    ;;
  "üóëÔ∏è Remove")
    sudo dnf remove -y "$clean_pkg" && update_cache
    ;;
  "‚¨ÜÔ∏è Update")
    sudo dnf upgrade -y "$clean_pkg" && update_cache
    ;;
  "üß© Dependencies")
    clear
    echo "üîç Dependencies for $clean_pkg:"
    dnf repoquery --requires "$clean_pkg" 2>/dev/null | sed 's/^/   ‚Ä¢ /'
    echo -e "\nPress Enter to go back..."
    read
    ;;
  "‚Ü©Ô∏è Back" | "") continue ;;
  esac
done
